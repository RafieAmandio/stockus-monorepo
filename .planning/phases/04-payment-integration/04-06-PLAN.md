---
phase: 04-payment-integration
plan: 06
type: execute
wave: 2
depends_on: ["04-01", "04-03"]
files_modified:
  - backend/src/routes/referrals.ts
  - backend/src/routes/index.ts
autonomous: true

must_haves:
  truths:
    - "Member can view their referral code"
    - "Member can view their referral stats (uses, rewards)"
    - "User can validate a referral code before checkout"
  artifacts:
    - path: "backend/src/routes/referrals.ts"
      provides: "Referral management endpoints"
      exports: ["referralRoutes"]
      min_lines: 60
  key_links:
    - from: "backend/src/routes/referrals.ts"
      to: "referral.service.ts"
      via: "getReferralStats, validateReferralCode"
      pattern: "getReferralStats|validateReferralCode"
---

<objective>
Create referral routes for viewing stats and validating codes

Purpose: Allow members to view their referral code and stats, and allow users to validate referral codes before checkout.
Output: Referral routes mounted at /referrals
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-payment-integration/04-RESEARCH.md

Existing patterns to follow:
@backend/src/routes/courses.ts (route pattern with auth middleware)
@backend/src/routes/index.ts (route mounting pattern)
@backend/src/middleware/auth.ts (authMiddleware, requireTier pattern)

From prior plans in this phase:
- 04-01: Referral schemas (referrals, referralUsages tables)
- 04-03: Referral service (getReferralStats, validateReferralCode)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create referral routes</name>
  <files>backend/src/routes/referrals.ts</files>
  <action>
Create `backend/src/routes/referrals.ts`:

```typescript
import { Hono } from 'hono'
import { zValidator } from '@hono/zod-validator'
import { z } from 'zod'
import { authMiddleware, requireTier, AuthEnv } from '../middleware/auth.js'
import {
  getReferralStats,
  validateReferralCode,
  generateReferralCode,
} from '../services/referral.service.js'

const validateCodeSchema = z.object({
  code: z.string().min(1),
})

const referralRoutes = new Hono<AuthEnv>()

/**
 * GET /referrals/my-code
 * Get authenticated member's referral code and stats
 * Members only - referral code is generated on first subscription
 */
referralRoutes.get(
  '/my-code',
  authMiddleware,
  requireTier('member'),
  async (c) => {
    const userId = c.get('userId')

    // Get or generate referral code
    const existingStats = await getReferralStats(userId)

    if (existingStats) {
      return c.json({
        code: existingStats.code,
        stats: {
          totalUses: existingStats.totalUses,
          rewardsEarned: existingStats.rewardsEarned,
          recentUsages: existingStats.recentUsages,
        },
      })
    }

    // Generate new code if member doesn't have one
    // (This handles members who upgraded before referral system was implemented)
    const result = await generateReferralCode(userId)

    if (!result.success) {
      return c.json({ error: result.error }, 500)
    }

    return c.json({
      code: result.code,
      stats: {
        totalUses: 0,
        rewardsEarned: 0,
        recentUsages: [],
      },
    })
  }
)

/**
 * GET /referrals/stats
 * Get detailed referral stats for member dashboard
 * Members only
 */
referralRoutes.get(
  '/stats',
  authMiddleware,
  requireTier('member'),
  async (c) => {
    const userId = c.get('userId')

    const stats = await getReferralStats(userId)

    if (!stats) {
      return c.json({
        code: null,
        totalUses: 0,
        rewardsEarned: 0,
        recentUsages: [],
      })
    }

    return c.json({
      code: stats.code,
      totalUses: stats.totalUses,
      rewardsEarned: stats.rewardsEarned,
      recentUsages: stats.recentUsages,
    })
  }
)

/**
 * POST /referrals/validate
 * Validate a referral code (for use during checkout)
 * Public endpoint - any authenticated user can validate
 */
referralRoutes.post(
  '/validate',
  authMiddleware,
  zValidator('json', validateCodeSchema),
  async (c) => {
    const userId = c.get('userId')
    const body = c.req.valid('json')

    const result = await validateReferralCode(body.code)

    if (!result.success) {
      return c.json({ valid: false, error: result.error }, 400)
    }

    // Cannot use own referral code
    if (result.referrerId === userId) {
      return c.json({
        valid: false,
        error: 'Cannot use your own referral code',
      }, 400)
    }

    return c.json({ valid: true })
  }
)

export { referralRoutes }
```
  </action>
  <verify>
Run `npx tsc --noEmit` - no errors
  </verify>
  <done>
referralRoutes exports with my-code, stats, and validate endpoints
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount referral routes</name>
  <files>backend/src/routes/index.ts</files>
  <action>
Update `backend/src/routes/index.ts` to mount referral routes:

Add import:
```typescript
import { referralRoutes } from './referrals.js'
```

Add route mounting:
```typescript
// Referral routes
routes.route('/referrals', referralRoutes)
```
  </action>
  <verify>
1. Run `npx tsc --noEmit` - no errors
2. Check routes/index.ts imports referralRoutes
3. Verify referralRoutes is mounted at /referrals
  </verify>
  <done>
Referral routes mounted at /referrals
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd backend && npx tsc --noEmit` passes
2. Route mounting: referralRoutes mounted at /referrals in routes/index.ts
3. Endpoints available:
   - GET /referrals/my-code (member only - returns code and stats)
   - GET /referrals/stats (member only - detailed stats)
   - POST /referrals/validate (authenticated - validate code for checkout)
4. Authorization: my-code and stats require member tier
5. Validation: Cannot use own referral code
</verification>

<success_criteria>
- Members can view their unique referral code
- Members can view usage stats and rewards earned
- Code is auto-generated if member doesn't have one
- Validation endpoint prevents using own code
- Non-members cannot access referral code endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/04-payment-integration/04-06-SUMMARY.md`
</output>
