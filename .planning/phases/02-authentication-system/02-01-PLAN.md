---
phase: 02-authentication-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/db/schema/users.ts
  - backend/src/db/schema/tokens.ts
  - backend/src/db/schema/sessions.ts
  - backend/src/db/schema/index.ts
  - backend/drizzle.config.ts
autonomous: true

must_haves:
  truths:
    - "Database schema supports verification tokens with expiration"
    - "Database schema supports refresh token sessions"
    - "Users have tier field for access control"
  artifacts:
    - path: "backend/src/db/schema/tokens.ts"
      provides: "Verification and password reset token storage"
      exports: ["tokens"]
    - path: "backend/src/db/schema/sessions.ts"
      provides: "Refresh token session storage"
      exports: ["sessions"]
    - path: "backend/src/db/schema/users.ts"
      provides: "User tier field"
      contains: "tier"
  key_links:
    - from: "backend/drizzle.config.ts"
      to: "schema files"
      via: "explicit schema array"
      pattern: "schema:.*tokens\\.ts.*sessions\\.ts"
---

<objective>
Extend database schema with authentication tables (tokens, sessions) and add tier column to users table.

Purpose: Provide database foundation for JWT refresh tokens, email verification tokens, and password reset tokens required by authentication system.
Output: New schema files, updated drizzle config, generated migration.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-system/02-RESEARCH.md

# Existing schema pattern
@backend/src/db/schema/users.ts
@backend/drizzle.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tokens schema for verification and password reset</name>
  <files>backend/src/db/schema/tokens.ts</files>
  <action>
Create tokens table schema following existing users.ts pattern:

```typescript
import { pgTable, serial, integer, varchar, timestamp } from 'drizzle-orm/pg-core'
import { users } from './users.js'

export const tokens = pgTable('tokens', {
  id: serial('id').primaryKey(),
  userId: integer('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  type: varchar('type', { length: 50 }).notNull(), // 'email_verification' | 'password_reset'
  tokenHash: varchar('token_hash', { length: 64 }).notNull().unique(), // SHA-256 hash
  expiresAt: timestamp('expires_at').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
})
```

Key points:
- Use .js extension for local import (ESM compatibility)
- Foreign key references users.id with cascade delete
- tokenHash is 64 chars (SHA-256 hex output)
- Type field distinguishes verification vs reset tokens
  </action>
  <verify>TypeScript compiles: `cd backend && npx tsc --noEmit`</verify>
  <done>tokens.ts exists with correct schema, imports users relation, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Create sessions schema for refresh tokens</name>
  <files>backend/src/db/schema/sessions.ts</files>
  <action>
Create sessions table schema for refresh token storage:

```typescript
import { pgTable, serial, integer, varchar, timestamp } from 'drizzle-orm/pg-core'
import { users } from './users.js'

export const sessions = pgTable('sessions', {
  id: serial('id').primaryKey(),
  userId: integer('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  tokenHash: varchar('token_hash', { length: 64 }).notNull().unique(), // SHA-256 hash
  expiresAt: timestamp('expires_at').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
})
```

Key points:
- Same pattern as tokens table
- Cascade delete ensures orphan cleanup
- tokenHash unique constraint prevents duplicate sessions
  </action>
  <verify>TypeScript compiles: `cd backend && npx tsc --noEmit`</verify>
  <done>sessions.ts exists with correct schema, references users table</done>
</task>

<task type="auto">
  <name>Task 3: Add tier column to users and update schema exports</name>
  <files>backend/src/db/schema/users.ts, backend/src/db/schema/index.ts, backend/drizzle.config.ts</files>
  <action>
1. Update users.ts - add tier column after isVerified:
```typescript
tier: varchar('tier', { length: 20 }).default('free').notNull(), // 'anonymous' | 'free' | 'member'
```

2. Update schema/index.ts barrel export to include new schemas:
```typescript
export * from './users.js'
export * from './tokens.js'
export * from './sessions.js'
```

3. Update drizzle.config.ts schema array (IMPORTANT: explicit files, not glob):
```typescript
schema: [
  './src/db/schema/users.ts',
  './src/db/schema/tokens.ts',
  './src/db/schema/sessions.ts',
],
```

4. Generate migration:
```bash
cd backend && npm run db:generate
```

Verify migration file created in backend/drizzle/ directory with tokens, sessions tables and tier column.
  </action>
  <verify>
1. `cd backend && npx tsc --noEmit` passes
2. `cd backend && npm run db:generate` creates migration file
3. Migration SQL contains: CREATE TABLE tokens, CREATE TABLE sessions, ALTER TABLE users ADD tier
  </verify>
  <done>All schema files updated, barrel exports new tables, drizzle config includes new files, migration generated</done>
</task>

</tasks>

<verification>
1. All TypeScript files compile without errors
2. Migration file exists in backend/drizzle/ with correct SQL
3. Schema files follow established patterns from 01-02
</verification>

<success_criteria>
- tokens and sessions tables defined with correct foreign keys
- users.tier column added with 'free' default
- drizzle.config.ts updated with all schema files
- Migration generated (application not blocked by DB not running)
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-system/02-01-SUMMARY.md`
</output>
