---
phase: 02-authentication-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/config/env.ts
  - backend/src/services/token.service.ts
  - backend/src/services/email.service.ts
  - backend/.env.example
autonomous: true
user_setup:
  - service: resend
    why: "Transactional email for verification and password reset"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard (resend.com) -> API Keys -> Create API Key"
      - name: EMAIL_FROM
        source: "Your verified sender email (e.g., noreply@yourdomain.com)"
    dashboard_config:
      - task: "Verify domain for sending"
        location: "Resend Dashboard -> Domains -> Add Domain"

must_haves:
  truths:
    - "Environment validates JWT secret exists with minimum length"
    - "Token service generates cryptographically secure tokens"
    - "Email service can send transactional emails via Resend"
  artifacts:
    - path: "backend/src/services/token.service.ts"
      provides: "Secure token generation and hashing"
      exports: ["generateToken", "hashToken", "verifyTokenHash"]
    - path: "backend/src/services/email.service.ts"
      provides: "Email sending via Resend"
      exports: ["sendVerificationEmail", "sendPasswordResetEmail"]
    - path: "backend/src/config/env.ts"
      provides: "JWT and email configuration"
      contains: "JWT_SECRET"
  key_links:
    - from: "backend/src/services/email.service.ts"
      to: "Resend API"
      via: "RESEND_API_KEY environment variable"
      pattern: "new Resend.*env\\.RESEND_API_KEY"
---

<objective>
Create foundation services for authentication: environment config extension, token generation/hashing utilities, and email service.

Purpose: Provide reusable building blocks for auth routes - secure token generation for verification/reset flows, email sending for user communication.
Output: Extended env config, token.service.ts, email.service.ts with helper functions.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-system/02-RESEARCH.md

# Existing patterns
@backend/src/config/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend environment configuration for authentication</name>
  <files>backend/src/config/env.ts, backend/.env.example</files>
  <action>
1. Update env.ts to add authentication-related environment variables:

Add to envSchema object (after LOG_LEVEL):
```typescript
// Authentication
JWT_SECRET: z.string().min(32, 'JWT_SECRET must be at least 32 characters'),
JWT_ACCESS_EXPIRES_MINUTES: z.string().default('15').transform(Number),
JWT_REFRESH_EXPIRES_DAYS: z.string().default('7').transform(Number),

// Email (Resend)
RESEND_API_KEY: z.string().startsWith('re_'),
EMAIL_FROM: z.string().email(),

// URLs
FRONTEND_URL: z.string().url(),
BACKEND_URL: z.string().url(),
```

2. Update backend/.env.example with new variables (add after LOG_LEVEL):
```
# Authentication
JWT_SECRET=your-secret-key-at-least-32-characters-long
JWT_ACCESS_EXPIRES_MINUTES=15
JWT_REFRESH_EXPIRES_DAYS=7

# Email (Resend)
RESEND_API_KEY=re_your_api_key
EMAIL_FROM=noreply@yourdomain.com

# URLs
FRONTEND_URL=http://localhost:3000
BACKEND_URL=http://localhost:3001
```

Key points:
- JWT_SECRET minimum 32 chars (256 bits) per OWASP recommendations
- Resend API key starts with 're_' prefix
- Transform string to number for expiration values
  </action>
  <verify>
1. Create backend/.env with valid test values
2. `cd backend && npx tsx -e "import { env } from './src/config/env.js'; console.log('JWT_SECRET length:', env.JWT_SECRET.length)"` prints length >= 32
  </verify>
  <done>env.ts validates all auth variables, .env.example documents them</done>
</task>

<task type="auto">
  <name>Task 2: Create token service with crypto utilities</name>
  <files>backend/src/services/token.service.ts</files>
  <action>
Create services directory and token.service.ts:

```typescript
import crypto from 'crypto'

/**
 * Generate a cryptographically secure random token
 * @param bytes Number of random bytes (default 32 = 64 hex chars)
 */
export function generateToken(bytes = 32): string {
  return crypto.randomBytes(bytes).toString('hex')
}

/**
 * Hash a token using SHA-256 for secure database storage
 */
export function hashToken(token: string): string {
  return crypto.createHash('sha256').update(token).digest('hex')
}

/**
 * Verify a token against a stored hash using timing-safe comparison
 */
export function verifyTokenHash(token: string, storedHash: string): boolean {
  const computedHash = hashToken(token)
  try {
    return crypto.timingSafeEqual(
      Buffer.from(computedHash, 'hex'),
      Buffer.from(storedHash, 'hex')
    )
  } catch {
    // Lengths don't match
    return false
  }
}

/**
 * Create a Date object N minutes from now
 */
export function minutesFromNow(minutes: number): Date {
  return new Date(Date.now() + minutes * 60 * 1000)
}

/**
 * Create a Date object N days from now
 */
export function daysFromNow(days: number): Date {
  return new Date(Date.now() + days * 24 * 60 * 60 * 1000)
}

/**
 * Create a Date object N hours from now
 */
export function hoursFromNow(hours: number): Date {
  return new Date(Date.now() + hours * 60 * 60 * 1000)
}
```

Key points:
- No external dependencies (uses Node.js crypto)
- Timing-safe comparison prevents timing attacks
- Helper functions for expiration timestamps
  </action>
  <verify>
`cd backend && npx tsx -e "
import { generateToken, hashToken, verifyTokenHash } from './src/services/token.service.js'
const token = generateToken()
const hash = hashToken(token)
console.log('Token length:', token.length)
console.log('Hash length:', hash.length)
console.log('Verify correct:', verifyTokenHash(token, hash))
console.log('Verify wrong:', verifyTokenHash('wrong', hash))
"`
Expected: Token length 64, Hash length 64, Verify correct true, Verify wrong false
  </verify>
  <done>token.service.ts exports all helper functions, verification passes</done>
</task>

<task type="auto">
  <name>Task 3: Create email service with Resend integration</name>
  <files>backend/src/services/email.service.ts</files>
  <action>
First install Resend: `cd backend && npm install resend`

Then create email.service.ts:

```typescript
import { Resend } from 'resend'
import { env } from '../config/env.js'

const resend = new Resend(env.RESEND_API_KEY)

interface EmailResult {
  success: boolean
  messageId?: string
  error?: string
}

/**
 * Send email verification link to new user
 */
export async function sendVerificationEmail(
  to: string,
  token: string,
  userName: string
): Promise<EmailResult> {
  const verificationUrl = `${env.FRONTEND_URL}/verify-email?token=${token}`

  try {
    const { data, error } = await resend.emails.send({
      from: env.EMAIL_FROM,
      to,
      subject: 'Verify your StockUs account',
      html: `
        <h2>Welcome to StockUs, ${userName}!</h2>
        <p>Please verify your email address by clicking the link below:</p>
        <p><a href="${verificationUrl}">Verify Email</a></p>
        <p>This link expires in 24 hours.</p>
        <p>If you didn't create an account, you can safely ignore this email.</p>
      `,
    })

    if (error) {
      return { success: false, error: error.message }
    }

    return { success: true, messageId: data?.id }
  } catch (err) {
    return {
      success: false,
      error: err instanceof Error ? err.message : 'Unknown error'
    }
  }
}

/**
 * Send password reset link
 */
export async function sendPasswordResetEmail(
  to: string,
  token: string
): Promise<EmailResult> {
  const resetUrl = `${env.FRONTEND_URL}/reset-password?token=${token}`

  try {
    const { data, error } = await resend.emails.send({
      from: env.EMAIL_FROM,
      to,
      subject: 'Reset your StockUs password',
      html: `
        <h2>Password Reset Request</h2>
        <p>Click the link below to reset your password:</p>
        <p><a href="${resetUrl}">Reset Password</a></p>
        <p>This link expires in 1 hour.</p>
        <p>If you didn't request this, you can safely ignore this email.</p>
      `,
    })

    if (error) {
      return { success: false, error: error.message }
    }

    return { success: true, messageId: data?.id }
  } catch (err) {
    return {
      success: false,
      error: err instanceof Error ? err.message : 'Unknown error'
    }
  }
}

/**
 * Send password changed notification
 */
export async function sendPasswordChangedEmail(to: string): Promise<EmailResult> {
  try {
    const { data, error } = await resend.emails.send({
      from: env.EMAIL_FROM,
      to,
      subject: 'Your StockUs password was changed',
      html: `
        <h2>Password Changed</h2>
        <p>Your password has been successfully changed.</p>
        <p>If you did not make this change, please contact support immediately.</p>
      `,
    })

    if (error) {
      return { success: false, error: error.message }
    }

    return { success: true, messageId: data?.id }
  } catch (err) {
    return {
      success: false,
      error: err instanceof Error ? err.message : 'Unknown error'
    }
  }
}
```

Key points:
- Returns result object with success flag (doesn't throw)
- HTML templates inline (simple for MVP, can upgrade to React Email later)
- Uses env config for URLs and sender
  </action>
  <verify>
1. `cd backend && npm ls resend` shows resend installed
2. `cd backend && npx tsc --noEmit` compiles without errors
  </verify>
  <done>email.service.ts created with all email functions, resend installed, TypeScript compiles</done>
</task>

</tasks>

<verification>
1. All new files compile with TypeScript
2. Token service functions work correctly (generate, hash, verify)
3. Resend package installed in dependencies
4. Environment validates new variables
</verification>

<success_criteria>
- env.ts validates JWT_SECRET (min 32 chars), RESEND_API_KEY, EMAIL_FROM, URLs
- token.service.ts provides generateToken, hashToken, verifyTokenHash, time helpers
- email.service.ts provides sendVerificationEmail, sendPasswordResetEmail, sendPasswordChangedEmail
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-system/02-02-SUMMARY.md`
</output>
