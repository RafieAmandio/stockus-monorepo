---
phase: 03-content-api
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - backend/src/routes/research.ts
  - backend/src/routes/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create research reports with publication dates"
    - "Admin can update existing research reports"
    - "Admin can soft-delete research reports"
    - "Authenticated users can list and view research reports"
    - "Members-only reports restricted by tier"
  artifacts:
    - path: "backend/src/routes/research.ts"
      provides: "Research report CRUD endpoints"
      exports: ["researchRoutes"]
    - path: "backend/src/routes/index.ts"
      provides: "Route mounting for /research"
      contains: "routes.route.*research"
  key_links:
    - from: "backend/src/routes/research.ts"
      to: "backend/src/middleware/auth.ts"
      via: "middleware imports"
      pattern: "import.*authMiddleware.*requireAdmin"
    - from: "backend/src/routes/research.ts"
      to: "backend/src/db/schema/research.ts"
      via: "schema import"
      pattern: "import.*researchReports"
---

<objective>
Implement CRUD endpoints for research reports with tier-based access control.

Purpose: Research reports are key content for premium members. This delivers the complete research API with publication date support.
Output: Research routes file with list, get, create, update, delete endpoints.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-api/03-RESEARCH.md
@.planning/phases/03-content-api/03-CONTEXT.md
@.planning/phases/03-content-api/03-01-SUMMARY.md
@.planning/phases/03-content-api/03-02-SUMMARY.md

@backend/src/routes/courses.ts
@backend/src/middleware/auth.ts
@backend/src/db/schema/research.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create research routes with CRUD operations</name>
  <files>
    backend/src/routes/research.ts
  </files>
  <action>
Create research.ts following the same patterns as courses.ts:

**Imports:**
- Hono, zValidator, z
- db from ../db/index.js
- researchReports from ../db/schema/index.js
- authMiddleware, requireAdmin, AuthEnv from ../middleware/auth.js
- generateSlug, createUniqueSlug from ../utils/slug.js
- eq, desc, isNull, and from drizzle-orm

**Zod Schemas:**
```typescript
const createReportSchema = z.object({
  title: z.string().min(3).max(255),
  summary: z.string().optional(),
  content: z.string().optional(), // HTML content
  publishedAt: z.string().datetime().optional(), // ISO date string
  isFreePreview: z.boolean().default(false),
})

const updateReportSchema = createReportSchema.partial()
```

**Endpoints:**

1. **GET /** - List research reports (auth required)
   - Apply authMiddleware
   - Query where deletedAt IS NULL, status = 'published'
   - Order by publishedAt DESC (newest first)
   - For non-members, filter or mark restricted
   - Return { reports: [...] }

2. **GET /:idOrSlug** - Get single report (auth required)
   - Apply authMiddleware
   - If param is numeric, query by id; else query by slug
   - Check tier access: if !isFreePreview and userTier !== 'member', return 403
   - Return { report }

3. **POST /** - Create report (admin only)
   - Apply authMiddleware, requireAdmin()
   - Validate with createReportSchema
   - Generate unique slug from title
   - Set status = 'published'
   - If publishedAt provided, parse to Date; else use new Date()
   - Insert and return { report }

4. **PATCH /:id** - Update report (admin only)
   - Apply authMiddleware, requireAdmin()
   - Validate with updateReportSchema
   - If title changed, regenerate slug
   - Update updatedAt
   - Return { report }

5. **DELETE /:id** - Soft delete report (admin only)
   - Apply authMiddleware, requireAdmin()
   - Set deletedAt = new Date(), status = 'archived'
   - Return { message: 'Report deleted' }

Export: `export const researchRoutes = research`
  </action>
  <verify>
`npx tsc --noEmit` from backend/ - no TypeScript errors
  </verify>
  <done>
research.ts exports researchRoutes with 5 endpoints for report CRUD
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount research routes</name>
  <files>
    backend/src/routes/index.ts
  </files>
  <action>
Update routes/index.ts to mount research routes:

1. Import researchRoutes from ./research.js
2. Add route mounting: `routes.route('/research', researchRoutes)`

Add below the courses route mounting.
  </action>
  <verify>
`npx tsc --noEmit` from backend/ - no TypeScript errors
  </verify>
  <done>
Research routes mounted at /research/* and application compiles
  </done>
</task>

</tasks>

<verification>
- [ ] research.ts has 5 endpoints (list, get, create, update, delete)
- [ ] Auth middleware on all endpoints
- [ ] Admin-only middleware on write operations
- [ ] Tier access control on read operations
- [ ] publishedAt handling for publication dates
- [ ] Routes mounted in index.ts
- [ ] TypeScript compiles: `cd backend && npx tsc --noEmit`
</verification>

<success_criteria>
- Admin can create, update, soft-delete research reports
- Reports have publication dates that can be set/updated
- Authenticated users can list/view reports
- Members-only reports properly gated
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-api/03-04-SUMMARY.md`
</output>
