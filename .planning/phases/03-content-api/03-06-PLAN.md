---
phase: 03-content-api
plan: 06
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/src/routes/cohorts.ts
  - backend/src/routes/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create cohorts with start/end dates"
    - "Admin can manage enrollment windows (open/close dates)"
    - "Admin can add sessions to cohorts with dates and Zoom links"
    - "Admin can update and soft-delete cohorts"
    - "Authenticated users can view cohort schedules"
  artifacts:
    - path: "backend/src/routes/cohorts.ts"
      provides: "Cohort CRUD and session management endpoints"
      exports: ["cohortRoutes"]
    - path: "backend/src/routes/index.ts"
      provides: "Route mounting for /cohorts"
      contains: "routes.route.*cohorts"
  key_links:
    - from: "backend/src/routes/cohorts.ts"
      to: "backend/src/middleware/auth.ts"
      via: "middleware imports"
      pattern: "import.*authMiddleware.*requireAdmin"
    - from: "backend/src/routes/cohorts.ts"
      to: "backend/src/db/schema/cohorts.ts"
      via: "schema imports"
      pattern: "import.*cohorts.*cohortSessions"
---

<objective>
Implement cohort management endpoints with sessions for scheduled course delivery.

Purpose: Cohorts are time-bound instances of courses with live sessions. This delivers CRUD for cohorts and their scheduled sessions with Zoom integration.
Output: Cohort routes with full CRUD for cohorts and cohort sessions.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-api/03-RESEARCH.md
@.planning/phases/03-content-api/03-CONTEXT.md
@.planning/phases/03-content-api/03-01-SUMMARY.md

@backend/src/routes/courses.ts
@backend/src/middleware/auth.ts
@backend/src/db/schema/cohorts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cohort routes with CRUD operations</name>
  <files>
    backend/src/routes/cohorts.ts
  </files>
  <action>
Create cohorts.ts with cohort and session management:

**Imports:**
- Hono, zValidator, z
- db from ../db/index.js
- cohorts, cohortSessions, courses from ../db/schema/index.js
- authMiddleware, requireAdmin, AuthEnv from ../middleware/auth.js
- eq, desc, isNull, asc from drizzle-orm

**Zod Schemas:**
```typescript
const createCohortSchema = z.object({
  courseId: z.number().int().positive(),
  name: z.string().min(1).max(255), // e.g., "Q1 2026 Cohort"
  startDate: z.string().datetime(), // ISO date
  endDate: z.string().datetime(),
  enrollmentOpenDate: z.string().datetime().optional(),
  enrollmentCloseDate: z.string().datetime().optional(),
  status: z.enum(['upcoming', 'open', 'closed', 'completed']).default('upcoming'),
  maxParticipants: z.number().int().positive().optional(),
})

const updateCohortSchema = createCohortSchema.partial().omit({ courseId: true })

const createCohortSessionSchema = z.object({
  courseSessionId: z.number().int().positive().optional(), // Link to course session
  title: z.string().min(1).max(255),
  scheduledAt: z.string().datetime(),
  zoomLink: z.string().url().optional(),
  sessionOrder: z.number().int().positive(),
})

const updateCohortSessionSchema = createCohortSessionSchema.partial()
```

**Endpoints:**

1. **GET /** - List cohorts (auth required)
   - Apply authMiddleware
   - Query where deletedAt IS NULL
   - Include course info and session count
   - Order by startDate ASC (upcoming first)
   - Return { cohorts: [...] }

2. **GET /:id** - Get cohort with sessions (auth required)
   - Apply authMiddleware
   - Query by id where deletedAt IS NULL
   - Include all sessions ordered by sessionOrder, then scheduledAt
   - Include course info
   - Return { cohort }

3. **POST /** - Create cohort (admin only)
   - Apply authMiddleware, requireAdmin()
   - Validate with createCohortSchema
   - Verify courseId exists
   - Parse date strings to Date objects
   - Insert and return { cohort }

4. **PATCH /:id** - Update cohort (admin only)
   - Apply authMiddleware, requireAdmin()
   - Validate with updateCohortSchema
   - Parse date strings if provided
   - Update updatedAt
   - Return { cohort }

5. **DELETE /:id** - Soft delete cohort (admin only)
   - Apply authMiddleware, requireAdmin()
   - Set deletedAt = new Date()
   - Return { message: 'Cohort deleted' }

6. **POST /:cohortId/sessions** - Add session to cohort (admin only)
   - Apply authMiddleware, requireAdmin()
   - Validate with createCohortSessionSchema
   - Verify cohort exists and is not deleted
   - If courseSessionId provided, verify it exists
   - Insert session and return { session }

7. **PATCH /:cohortId/sessions/:sessionId** - Update session (admin only)
   - Apply authMiddleware, requireAdmin()
   - Validate with updateCohortSessionSchema
   - Update session (Zoom link, scheduled time, etc.)
   - Return { session }

8. **DELETE /:cohortId/sessions/:sessionId** - Delete session (admin only)
   - Apply authMiddleware, requireAdmin()
   - Hard delete session (they cascade anyway)
   - Return { message: 'Session deleted' }

Export: `export const cohortRoutes = cohorts`

**Note:** Date handling - parse ISO strings to Date objects before inserting. The schema uses `timestamp('column', { mode: 'date' })` which expects JavaScript Date objects.
  </action>
  <verify>
`npx tsc --noEmit` from backend/ - no TypeScript errors
  </verify>
  <done>
cohorts.ts exports cohortRoutes with 8 endpoints for cohort and session management
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount cohort routes</name>
  <files>
    backend/src/routes/index.ts
  </files>
  <action>
Update routes/index.ts to mount cohort routes:

1. Import cohortRoutes from ./cohorts.js
2. Add route mounting: `routes.route('/cohorts', cohortRoutes)`

The final routes/index.ts should have all content routes:
- /health
- /auth
- /courses
- /research
- /templates
- /cohorts
  </action>
  <verify>
`npx tsc --noEmit` from backend/ - no TypeScript errors
  </verify>
  <done>
Cohort routes mounted at /cohorts/* and all Phase 3 routes are mounted
  </done>
</task>

</tasks>

<verification>
- [ ] cohorts.ts has 8 endpoints (5 cohort CRUD + 3 session CRUD)
- [ ] Auth middleware on all endpoints
- [ ] Admin-only middleware on write operations
- [ ] Date handling converts ISO strings to Date objects
- [ ] Zoom links stored for sessions
- [ ] Course relation verified on cohort creation
- [ ] Routes mounted in index.ts
- [ ] TypeScript compiles: `cd backend && npx tsc --noEmit`
</verification>

<success_criteria>
- Admin can create cohorts linked to courses
- Admin can set enrollment windows (open/close dates)
- Admin can manage cohort sessions with Zoom links and schedules
- Authenticated users can view cohort information and schedules
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-api/03-06-SUMMARY.md`
</output>
