---
phase: 03-content-api
plan: 05
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - backend/src/routes/templates.ts
  - backend/src/routes/index.ts
  - backend/.gitignore
autonomous: true

must_haves:
  truths:
    - "Admin can upload template files (PDF, Excel, Word)"
    - "Admin can update template metadata"
    - "Admin can soft-delete templates"
    - "Authenticated users can list templates"
    - "Members can download templates"
    - "File uploads validated for type and size"
  artifacts:
    - path: "backend/src/routes/templates.ts"
      provides: "Template CRUD and file upload endpoints"
      exports: ["templateRoutes"]
    - path: "backend/src/routes/index.ts"
      provides: "Route mounting for /templates"
      contains: "routes.route.*templates"
    - path: "backend/.gitignore"
      provides: "Ignores uploads directory"
      contains: "uploads/"
  key_links:
    - from: "backend/src/routes/templates.ts"
      to: "backend/src/utils/file-upload.ts"
      via: "file upload utilities"
      pattern: "import.*validateFile.*saveFile"
    - from: "backend/src/routes/templates.ts"
      to: "filesystem"
      via: "file operations"
      pattern: "readFile.*writeFile"
---

<objective>
Implement template upload, management, and download endpoints with file handling.

Purpose: Templates (PDFs, Excel sheets, Word docs) are downloadable resources for members. This delivers file upload with validation and download with tier gating.
Output: Template routes with upload, list, update, delete, and download endpoints.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-api/03-RESEARCH.md
@.planning/phases/03-content-api/03-CONTEXT.md
@.planning/phases/03-content-api/03-01-SUMMARY.md
@.planning/phases/03-content-api/03-02-SUMMARY.md

@backend/src/routes/courses.ts
@backend/src/middleware/auth.ts
@backend/src/utils/file-upload.ts
@backend/src/db/schema/templates.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create template routes with file upload</name>
  <files>
    backend/src/routes/templates.ts
  </files>
  <action>
Create templates.ts with file upload and download capabilities:

**Imports:**
- Hono, z
- db from ../db/index.js
- templates from ../db/schema/index.js
- authMiddleware, requireAdmin, AuthEnv from ../middleware/auth.js
- validateFile, saveFile, getUploadDir, ALLOWED_TEMPLATE_TYPES, MAX_FILE_SIZE from ../utils/file-upload.js
- eq, desc, isNull from drizzle-orm
- readFile from 'fs/promises'
- join from 'path'

**Endpoints:**

1. **GET /** - List templates (auth required)
   - Apply authMiddleware
   - Query where deletedAt IS NULL
   - Order by createdAt DESC
   - Return { templates: [...] } with metadata (no file content)

2. **GET /:id** - Get template metadata (auth required)
   - Apply authMiddleware
   - Query by id where deletedAt IS NULL
   - Return { template } with metadata

3. **GET /:id/download** - Download template file (tier-gated)
   - Apply authMiddleware
   - Query template by id
   - Check tier: if !isFreePreview and userTier !== 'member', return 403
   - Read file from disk using template.filename and getUploadDir('templates')
   - Return file with proper Content-Type, Content-Disposition headers
   - Use c.body() with headers for binary response

4. **POST /** - Upload new template (admin only)
   - Apply authMiddleware, requireAdmin()
   - Parse multipart: `const body = await c.req.parseBody()`
   - Extract file: `body.file` (validate is File, not string)
   - Extract metadata: `body.title`, `body.description`, `body.isFreePreview`
   - Validate file with validateFile(file, ALLOWED_TEMPLATE_TYPES)
   - If invalid, return 400 with error
   - Save file with saveFile(file, getUploadDir('templates'))
   - Insert template record with originalFilename, filename, filepath, fileSize, mimeType, uploadedBy
   - Return { template }

5. **PATCH /:id** - Update template metadata (admin only)
   - Apply authMiddleware, requireAdmin()
   - Update title, description, isFreePreview only (not file)
   - Return { template }

6. **DELETE /:id** - Soft delete template (admin only)
   - Apply authMiddleware, requireAdmin()
   - Set deletedAt = new Date()
   - Note: File remains on disk (cleanup is a v2 concern)
   - Return { message: 'Template deleted' }

Export: `export const templateRoutes = templates`

**Important:** Use parseBody() for multipart form data. The file comes as a File object with name, type, size, arrayBuffer() method.
  </action>
  <verify>
`npx tsc --noEmit` from backend/ - no TypeScript errors
  </verify>
  <done>
templates.ts exports templateRoutes with 6 endpoints including file upload and download
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount template routes and configure gitignore</name>
  <files>
    backend/src/routes/index.ts
    backend/.gitignore
  </files>
  <action>
**Update routes/index.ts:**
1. Import templateRoutes from ./templates.js
2. Add route mounting: `routes.route('/templates', templateRoutes)`

**Update backend/.gitignore:**
Add uploads directory to prevent committing uploaded files:
```
# Uploaded files
uploads/
```

If .gitignore doesn't exist, create it with:
```
node_modules/
dist/
.env
uploads/
```
  </action>
  <verify>
- `npx tsc --noEmit` from backend/ - no TypeScript errors
- `cat backend/.gitignore | grep uploads` shows uploads/ is ignored
  </verify>
  <done>
Template routes mounted at /templates/* and uploads directory is gitignored
  </done>
</task>

</tasks>

<verification>
- [ ] templates.ts has 6 endpoints (list, get, download, upload, update, delete)
- [ ] File upload validates type and size before saving
- [ ] Download endpoint checks tier access
- [ ] Files stored with UUID filenames
- [ ] Routes mounted in index.ts
- [ ] uploads/ added to .gitignore
- [ ] TypeScript compiles: `cd backend && npx tsc --noEmit`
</verification>

<success_criteria>
- Admin can upload PDF, Excel, Word files up to 10MB
- Admin can update template metadata
- Admin can soft-delete templates
- Authenticated users can list and view template metadata
- Members can download template files
- Free users can only download free preview templates
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-api/03-05-SUMMARY.md`
</output>
