---
phase: 05-video-storage
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - backend/src/routes/videos.ts
  - backend/src/routes/index.ts
  - backend/src/utils/file-upload.ts
autonomous: true

must_haves:
  truths:
    - "Admin can request presigned upload URL for video"
    - "Admin can confirm video upload and save metadata"
    - "Member can get presigned playback URL for video"
    - "Only authenticated members can access video URLs"
    - "Video metadata includes link to course session"
    - "Presigned URLs expire after configured duration"
  artifacts:
    - path: "backend/src/routes/videos.ts"
      provides: "Video management and playback routes"
      exports: ["videoRoutes"]
    - path: "backend/src/routes/index.ts"
      provides: "Video routes mounted"
      contains: "videoRoutes"
    - path: "backend/src/utils/file-upload.ts"
      provides: "Video validation constants"
      exports: ["ALLOWED_VIDEO_TYPES", "MAX_VIDEO_SIZE"]
  key_links:
    - from: "backend/src/routes/videos.ts"
      to: "backend/src/services/r2.service.ts"
      via: "import and presigned URL calls"
      pattern: "generateUploadUrl|generatePlaybackUrl"
    - from: "backend/src/routes/videos.ts"
      to: "backend/src/middleware/auth.ts"
      via: "requireAdmin and requireTier middleware"
      pattern: "requireAdmin|requireTier"
    - from: "backend/src/routes/videos.ts"
      to: "backend/src/db/schema/videos.ts"
      via: "database queries"
      pattern: "db\\..*videos"
    - from: "backend/src/routes/videos.ts"
      to: "backend/src/db/schema/courses.ts"
      via: "courseSessions update on confirm-upload"
      pattern: "db\\.update.*courseSessions"
---

<objective>
Implement video management routes for admin upload flow and member playback access with presigned URLs.

Purpose: Enables admins to upload session recordings to R2 and members to watch videos with time-limited secure URLs.
Output: Complete video API - admin can upload/manage, members can get playback URLs for course sessions.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-video-storage/05-RESEARCH.md
@.planning/phases/05-video-storage/05-01-SUMMARY.md

# Patterns to follow
@backend/src/routes/templates.ts
@backend/src/routes/courses.ts
@backend/src/middleware/auth.ts
@backend/src/services/r2.service.ts
@backend/src/db/schema/videos.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create video routes with admin upload flow</name>
  <files>
    backend/src/routes/videos.ts
  </files>
  <action>
Create `backend/src/routes/videos.ts` with the following endpoints:

**Admin Endpoints (require authMiddleware + requireAdmin):**

1. POST /videos/request-upload
   - Body: { filename: string, contentType: string, sizeBytes: number, sessionId?: number }
   - Validates contentType is in allowed video types: ['video/mp4', 'video/webm', 'video/quicktime', 'video/x-msvideo']
   - Validates sizeBytes <= 5GB (5 * 1024 * 1024 * 1024)
   - If sessionId provided, verify session exists
   - Generate UUID-based r2Key: `videos/${randomUUID()}.${extension}`
   - Call generateUploadUrl(r2Key, contentType)
   - Return { uploadUrl, r2Key, expiresIn: env.VIDEO_UPLOAD_URL_EXPIRY }

2. POST /videos/confirm-upload
   - Body: { r2Key: string, title: string, description?: string, contentType: string, sizeBytes: number, durationSeconds?: number, sessionId?: number }
   - Validates r2Key starts with 'videos/'
   - Inserts record into videos table with uploadedBy from context
   - If sessionId provided, update courseSessions.videoUrl:
     ```typescript
     await db.update(courseSessions)
       .set({ videoUrl: `/videos/${insertedVideo.id}/playback` })
       .where(eq(courseSessions.id, sessionId));
     ```
   - Return created video object with id

3. GET /videos (admin list)
   - Returns all videos with session and course info
   - Supports ?sessionId filter
   - Excludes soft-deleted (deletedAt IS NULL)

4. DELETE /videos/:id (soft delete)
   - Sets deletedAt timestamp
   - Returns { success: true }

**Member Endpoints (require authMiddleware + requireTier('member')):**

5. GET /videos/:id/playback
   - Finds video by id (not deleted)
   - Verifies video.sessionId links to a course session
   - Optionally verify member has access to this course (for now, any member can access)
   - Calls generatePlaybackUrl(video.r2Key)
   - Returns { playbackUrl, expiresIn, contentType, title }

**Validation:**
- Use Zod for request body validation
- Use zValidator from @hono/zod-validator

**Patterns to follow:**
- See templates.ts for file handling patterns
- See courses.ts for admin CRUD patterns
- Use randomUUID from crypto for r2Key generation
- Return result objects { success, error? } on mutations
  </action>
  <verify>
    - File exists: `ls backend/src/routes/videos.ts`
    - Has videoRoutes export: `grep "export.*videoRoutes" backend/src/routes/videos.ts`
    - Has all endpoints: `grep -c "\\.(get|post|delete)\\(" backend/src/routes/videos.ts` returns >= 5
    - Uses auth middleware: `grep "requireAdmin\\|requireTier" backend/src/routes/videos.ts`
    - Has courseSessions update: `grep "db.update.*courseSessions" backend/src/routes/videos.ts`
    - TypeScript compiles: `cd backend && npx tsc --noEmit`
  </verify>
  <done>
    Video routes implement admin upload flow (request-upload, confirm-upload, list, delete) and member playback endpoint with presigned URL generation. Confirm-upload also updates courseSessions.videoUrl when sessionId is provided.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount video routes and run migration</name>
  <files>
    backend/src/routes/index.ts
  </files>
  <action>
1. Update `backend/src/routes/index.ts`:
   - Add import: import { videoRoutes } from './videos.js'
   - Add route mounting: routes.route('/videos', videoRoutes)
   - Add comment: // Video routes (admin upload, member playback)
   - Place after cohort routes (maintain alphabetical-ish order)

2. Run database migration to create videos table:
   ```bash
   cd backend && npm run db:generate && npm run db:migrate
   ```
   This creates the videos table with the schema from 05-01.

Follow existing patterns in routes/index.ts for import and mounting.
  </action>
  <verify>
    - Route mounted: `grep "videoRoutes" backend/src/routes/index.ts`
    - Migration generated: `ls backend/drizzle/*.sql | tail -1` shows new migration
    - Server starts: `cd backend && timeout 5 npm run dev || true` (starts without crash)
  </verify>
  <done>
    Video routes mounted at /videos, database migration applied creating videos table. Server starts successfully.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add allowed video types constant to file-upload utility</name>
  <files>
    backend/src/utils/file-upload.ts
  </files>
  <action>
Update `backend/src/utils/file-upload.ts` to add video-specific constants:

1. Add new constant:
   ```typescript
   // Allowed MIME types for videos
   export const ALLOWED_VIDEO_TYPES = [
     'video/mp4',
     'video/webm',
     'video/quicktime', // .mov
     'video/x-msvideo', // .avi
   ];
   ```

2. Add video size constant:
   ```typescript
   // Video size limits (R2 single PUT limit is 5GB)
   export const MAX_VIDEO_SIZE = 5 * 1024 * 1024 * 1024; // 5GB
   ```

This centralizes video validation constants for use in routes and potential future video validation middleware.
  </action>
  <verify>
    - Has video types: `grep "ALLOWED_VIDEO_TYPES" backend/src/utils/file-upload.ts`
    - Has video size: `grep "MAX_VIDEO_SIZE" backend/src/utils/file-upload.ts`
    - TypeScript compiles: `cd backend && npx tsc --noEmit`
  </verify>
  <done>
    Video MIME type and size constants added to file-upload.ts utility, centralizing validation rules for video uploads.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. TypeScript compiles: `cd backend && npx tsc --noEmit`
2. Server starts: `cd backend && npm run dev` (test briefly, Ctrl+C)
3. Video routes accessible at /videos/*
4. Database has videos table (migration applied)
5. Admin and member auth properly enforced on endpoints

Test endpoints (requires valid R2 credentials):
- POST /videos/request-upload (admin only)
- GET /videos/:id/playback (member only)
</verification>

<success_criteria>
- videoRoutes exported from videos.ts with 5 endpoints
- Admin endpoints: POST /request-upload, POST /confirm-upload, GET /, DELETE /:id
- Member endpoint: GET /:id/playback
- Routes use requireAdmin() and requireTier('member') appropriately
- Presigned URL functions called for upload and playback
- Video metadata stored in database with r2Key
- Session linking supported (optional sessionId on upload)
- confirm-upload updates courseSessions.videoUrl when sessionId provided
- Routes mounted at /videos in index.ts
- Videos table created via migration
- Server starts successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-video-storage/05-02-SUMMARY.md`
</output>
