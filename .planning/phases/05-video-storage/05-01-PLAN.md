---
phase: 05-video-storage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/config/env.ts
  - backend/src/services/r2.service.ts
  - backend/src/db/schema/videos.ts
  - backend/src/db/schema/index.ts
autonomous: true
user_setup:
  - service: cloudflare-r2
    why: "S3-compatible object storage for video files"
    env_vars:
      - name: CLOUDFLARE_ACCOUNT_ID
        source: "Cloudflare Dashboard -> R2 -> Overview (in URL or sidebar)"
      - name: R2_ACCESS_KEY_ID
        source: "Cloudflare Dashboard -> R2 -> Manage R2 API Tokens -> Create API token"
      - name: R2_SECRET_ACCESS_KEY
        source: "Cloudflare Dashboard -> R2 -> Manage R2 API Tokens -> Create API token (shown once)"
      - name: R2_BUCKET_NAME
        source: "Cloudflare Dashboard -> R2 -> Create bucket -> Enter bucket name"
    dashboard_config:
      - task: "Create R2 bucket for videos"
        location: "Cloudflare Dashboard -> R2 -> Create bucket"
      - task: "Create R2 API token with Object Read & Write permissions"
        location: "Cloudflare Dashboard -> R2 -> Manage R2 API Tokens"
      - task: "Configure CORS policy on bucket"
        location: "Cloudflare Dashboard -> R2 -> {bucket} -> Settings -> CORS Policy"
        config: '{"AllowedOrigins":["*"],"AllowedMethods":["GET","PUT","POST","HEAD"],"AllowedHeaders":["*"],"ExposeHeaders":["ETag","Content-Length"],"MaxAgeSeconds":3600}'

must_haves:
  truths:
    - "R2 client connects to Cloudflare storage endpoint"
    - "Environment validates R2 credentials at startup"
    - "Video metadata schema supports linking to course sessions"
    - "Presigned URLs expire after configured duration"
  artifacts:
    - path: "backend/src/services/r2.service.ts"
      provides: "R2 client and presigned URL functions"
      exports: ["r2Client", "R2_BUCKET", "generateUploadUrl", "generatePlaybackUrl"]
    - path: "backend/src/db/schema/videos.ts"
      provides: "Video metadata table definition"
      contains: "videos"
    - path: "backend/src/config/env.ts"
      provides: "R2 environment variables"
      contains: "CLOUDFLARE_ACCOUNT_ID"
  key_links:
    - from: "backend/src/services/r2.service.ts"
      to: "@aws-sdk/client-s3"
      via: "S3Client import"
      pattern: "import.*S3Client.*@aws-sdk/client-s3"
    - from: "backend/src/db/schema/index.ts"
      to: "backend/src/db/schema/videos.ts"
      via: "export statement"
      pattern: "export.*videos"
---

<objective>
Set up Cloudflare R2 infrastructure for video storage including environment configuration, R2 client service, and database schema for video metadata.

Purpose: Establishes the foundation for secure video upload and playback - R2 client handles S3-compatible operations, schema stores video metadata linked to courses.
Output: R2 service ready for presigned URL generation, videos table ready for metadata storage.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-video-storage/05-RESEARCH.md

# Existing patterns to follow
@backend/src/config/env.ts
@backend/src/db/schema/courses.ts
@backend/src/db/schema/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install AWS SDK and add R2 environment variables</name>
  <files>
    backend/package.json
    backend/src/config/env.ts
  </files>
  <action>
1. Install AWS SDK packages:
   ```bash
   cd backend && npm install @aws-sdk/client-s3 @aws-sdk/s3-request-presigner
   ```

2. Update `backend/src/config/env.ts` to add R2 configuration variables:
   - Add to envSchema object:
     - CLOUDFLARE_ACCOUNT_ID: z.string().min(10)
     - R2_ACCESS_KEY_ID: z.string().min(10)
     - R2_SECRET_ACCESS_KEY: z.string().min(10)
     - R2_BUCKET_NAME: z.string().min(1)
     - VIDEO_UPLOAD_URL_EXPIRY: z.string().default('900').transform(Number) // 15 minutes
     - VIDEO_PLAYBACK_URL_EXPIRY: z.string().default('3600').transform(Number) // 1 hour

Follow existing pattern in env.ts - add comments explaining each variable purpose.
  </action>
  <verify>
    - `cat backend/package.json | grep aws-sdk` shows both packages installed
    - `grep -c "R2_" backend/src/config/env.ts` returns 4 (four R2 variables)
    - TypeScript compiles: `cd backend && npx tsc --noEmit`
  </verify>
  <done>
    AWS SDK packages installed, R2 environment variables defined in Zod schema with sensible defaults for URL expiry times.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create R2 service with presigned URL functions</name>
  <files>
    backend/src/services/r2.service.ts
  </files>
  <action>
Create `backend/src/services/r2.service.ts` that:

1. Imports S3Client from @aws-sdk/client-s3 and getSignedUrl from @aws-sdk/s3-request-presigner
2. Imports env from ../config/env.js
3. Creates and exports r2Client as S3Client configured with:
   - region: 'auto' (R2 uses 'auto')
   - endpoint: `https://${env.CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com`
   - credentials: { accessKeyId: env.R2_ACCESS_KEY_ID, secretAccessKey: env.R2_SECRET_ACCESS_KEY }
4. Exports R2_BUCKET = env.R2_BUCKET_NAME
5. Exports async function generateUploadUrl(videoKey: string, contentType: string): Promise<string>
   - Uses PutObjectCommand with Bucket, Key, ContentType
   - Returns presigned URL with expiresIn: env.VIDEO_UPLOAD_URL_EXPIRY
6. Exports async function generatePlaybackUrl(videoKey: string, expiresIn?: number): Promise<string>
   - Uses GetObjectCommand with Bucket, Key
   - Returns presigned URL with expiresIn defaulting to env.VIDEO_PLAYBACK_URL_EXPIRY

IMPORTANT: Use .js extension in imports (ESM). Follow existing service patterns (see email.service.ts, payment.service.ts).
  </action>
  <verify>
    - File exists: `ls backend/src/services/r2.service.ts`
    - Has required exports: `grep -E "export.*(r2Client|R2_BUCKET|generateUploadUrl|generatePlaybackUrl)" backend/src/services/r2.service.ts`
    - TypeScript compiles: `cd backend && npx tsc --noEmit`
  </verify>
  <done>
    R2 service exports r2Client singleton, R2_BUCKET constant, and two presigned URL generator functions for upload and playback.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create videos database schema and update exports</name>
  <files>
    backend/src/db/schema/videos.ts
    backend/src/db/schema/index.ts
  </files>
  <action>
1. Create `backend/src/db/schema/videos.ts`:
   - Import: pgTable, serial, varchar, text, integer, timestamp from drizzle-orm/pg-core
   - Import: relations from drizzle-orm
   - Import: courseSessions from ./courses.js (for foreign key reference)
   - Import: users from ./users.js (for uploadedBy reference)

   Create videos table with:
   - id: serial('id').primaryKey()
   - title: varchar('title', { length: 255 }).notNull()
   - description: text('description')
   - r2Key: varchar('r2_key', { length: 500 }).notNull().unique() // R2 object key
   - contentType: varchar('content_type', { length: 100 }).notNull() // e.g., 'video/mp4'
   - sizeBytes: integer('size_bytes').notNull()
   - durationSeconds: integer('duration_seconds') // Optional video length
   - sessionId: integer('session_id').references(() => courseSessions.id, { onDelete: 'set null' }) // Link to course session
   - uploadedBy: integer('uploaded_by').notNull().references(() => users.id)
   - deletedAt: timestamp('deleted_at', { mode: 'date' }) // Soft delete pattern
   - createdAt: timestamp('created_at', { mode: 'date' }).defaultNow().notNull()
   - updatedAt: timestamp('updated_at', { mode: 'date' }).defaultNow().notNull()

   Create relations:
   - videosRelations: session (one) to courseSessions, uploader (one) to users

2. Update `backend/src/db/schema/index.ts`:
   - Add: export * from './videos.js'

Follow existing schema patterns (see courses.ts, research.ts). Use { mode: 'date' } for timestamps.
  </action>
  <verify>
    - Schema file exists: `ls backend/src/db/schema/videos.ts`
    - Has videos table: `grep "export const videos" backend/src/db/schema/videos.ts`
    - Exported from index: `grep "videos" backend/src/db/schema/index.ts`
    - TypeScript compiles: `cd backend && npx tsc --noEmit`
  </verify>
  <done>
    Videos schema defines metadata table with r2Key for R2 object reference, optional sessionId for course linking, and follows established soft-delete pattern. Exported from schema barrel file.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. TypeScript compiles without errors: `cd backend && npx tsc --noEmit`
2. R2 service file has all required exports
3. Videos schema ready for migration (run in Plan 02 after routes complete)
4. Environment variables documented for user setup
</verification>

<success_criteria>
- AWS SDK v3 packages installed (@aws-sdk/client-s3, @aws-sdk/s3-request-presigner)
- R2 environment variables added to Zod schema with defaults
- r2.service.ts exports r2Client, R2_BUCKET, generateUploadUrl, generatePlaybackUrl
- videos.ts schema defines metadata table with r2Key, sessionId, uploadedBy
- All files use ESM imports (.js extensions)
- TypeScript compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-video-storage/05-01-SUMMARY.md`
</output>
