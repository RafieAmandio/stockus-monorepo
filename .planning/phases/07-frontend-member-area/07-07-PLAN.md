---
phase: 07-frontend-member-area
plan: 07
type: execute
wave: 3
depends_on: ["07-03"]
files_modified:
  - frontend/src/app/(auth)/downloads/page.tsx
  - frontend/src/components/member/DownloadButton.tsx
  - frontend/src/components/member/DownloadHistorySection.tsx
  - frontend/src/components/ui/progress.tsx
  - frontend/src/lib/download-history.ts
autonomous: true

must_haves:
  truths:
    - "Member can download all templates"
    - "Free users see limited templates"
    - "Download shows progress indicator"
    - "Template list shows file info"
    - "Member can view download history"
  artifacts:
    - path: "frontend/src/app/(auth)/downloads/page.tsx"
      provides: "Downloads page with template list"
      contains: "DownloadButton"
    - path: "frontend/src/components/member/DownloadButton.tsx"
      provides: "Download button with progress"
      contains: "use client"
    - path: "frontend/src/components/ui/progress.tsx"
      provides: "shadcn progress component"
  key_links:
    - from: "frontend/src/components/member/DownloadButton.tsx"
      to: "/templates/{id}/download"
      via: "axios with credentials"
      pattern: "axios.*templates.*download"
---

<objective>
Create downloads page with template list and download functionality. Members can download all templates with progress tracking, free users see limited templates.

Purpose: Members access and download investment templates and tools.
Output: Downloads page at /downloads with template list and download buttons.
</objective>

<execution_context>
@/Users/dio/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dio/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-frontend-member-area/07-03-PLAN.md (Layout)
@.planning/phases/07-frontend-member-area/07-RESEARCH.md (DownloadButton pattern)

# Backend template endpoints
@backend/src/routes/templates.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create download components</name>
  <files>
    frontend/package.json
    frontend/src/components/ui/progress.tsx
    frontend/src/components/member/DownloadButton.tsx
  </files>
  <action>
Install axios for download progress and add shadcn progress component:
```bash
cd frontend && npm install axios
cd frontend && npx shadcn@latest add progress
```

Create `frontend/src/lib/download-history.ts` for localStorage-based download tracking:
```typescript
// Download history tracking using localStorage (v1 - client-side only)

const HISTORY_KEY = 'stockus_download_history'

export interface DownloadRecord {
  templateId: number
  templateTitle: string
  filename: string
  downloadedAt: string // ISO date string
}

function getHistory(): DownloadRecord[] {
  if (typeof window === 'undefined') return []
  try {
    const data = localStorage.getItem(HISTORY_KEY)
    return data ? JSON.parse(data) : []
  } catch {
    return []
  }
}

function saveHistory(history: DownloadRecord[]): void {
  if (typeof window === 'undefined') return
  // Keep only last 50 downloads
  const trimmed = history.slice(-50)
  localStorage.setItem(HISTORY_KEY, JSON.stringify(trimmed))
}

export function recordDownload(templateId: number, templateTitle: string, filename: string): void {
  const history = getHistory()

  history.push({
    templateId,
    templateTitle,
    filename,
    downloadedAt: new Date().toISOString()
  })

  saveHistory(history)
}

export function getDownloadHistory(): DownloadRecord[] {
  return getHistory().reverse() // Most recent first
}

export function getRecentDownloads(limit: number = 5): DownloadRecord[] {
  return getDownloadHistory().slice(0, limit)
}

export function hasDownloaded(templateId: number): boolean {
  return getHistory().some(r => r.templateId === templateId)
}
```

Create `frontend/src/components/member/DownloadButton.tsx`:
```typescript
'use client'

import { useState } from 'react'
import axios from 'axios'
import { Button } from '@/components/ui/button'
import { Progress } from '@/components/ui/progress'
import { Download, CheckCircle, AlertCircle, Loader2 } from 'lucide-react'
import { recordDownload } from '@/lib/download-history'

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000'

/**
 * Extract filename from URL or Content-Disposition header
 * Falls back to provided fallbackFilename
 */
function extractFilename(url: string, fallbackFilename: string): string {
  // Try to get filename from URL path
  try {
    const urlPath = new URL(url, 'http://localhost').pathname
    const pathFilename = urlPath.split('/').pop()
    if (pathFilename && pathFilename.includes('.')) {
      return decodeURIComponent(pathFilename)
    }
  } catch {
    // URL parsing failed, continue to fallback
  }

  // Use fallback, ensure it has an extension
  if (!fallbackFilename.includes('.')) {
    return `${fallbackFilename}.xlsx` // Default extension for templates
  }
  return fallbackFilename
}

interface DownloadButtonProps {
  templateId: number
  templateTitle: string // Added for history tracking
  fileUrl: string // URL to derive filename from
  disabled?: boolean
}

export function DownloadButton({ templateId, templateTitle, fileUrl, disabled }: DownloadButtonProps) {
  const [progress, setProgress] = useState(0)
  const [status, setStatus] = useState<'idle' | 'downloading' | 'success' | 'error'>('idle')
  const [error, setError] = useState<string | null>(null)

  // Derive filename from fileUrl with proper fallback
  const filename = extractFilename(fileUrl, templateTitle)

  const handleDownload = async () => {
    setStatus('downloading')
    setProgress(0)
    setError(null)

    try {
      const response = await axios.get(
        `${API_URL}/templates/${templateId}/download`,
        {
          responseType: 'blob',
          withCredentials: true,
          onDownloadProgress: (progressEvent) => {
            const total = progressEvent.total || progressEvent.loaded
            const percent = Math.round((progressEvent.loaded * 100) / total)
            setProgress(percent)
          },
        }
      )

      // Try to get filename from Content-Disposition header
      let downloadFilename = filename
      const contentDisposition = response.headers['content-disposition']
      if (contentDisposition) {
        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/)
        if (filenameMatch && filenameMatch[1]) {
          downloadFilename = filenameMatch[1].replace(/['"]/g, '')
        }
      }

      // Create download link
      const url = window.URL.createObjectURL(new Blob([response.data]))
      const link = document.createElement('a')
      link.href = url
      link.setAttribute('download', downloadFilename)
      document.body.appendChild(link)
      link.click()
      link.remove()
      window.URL.revokeObjectURL(url)

      // Record in download history
      recordDownload(templateId, templateTitle, downloadFilename)

      setStatus('success')
      setTimeout(() => setStatus('idle'), 2000)
    } catch (err) {
      console.error('Download failed:', err)
      if (axios.isAxiosError(err) && err.response?.status === 403) {
        setError('Anda tidak memiliki akses. Upgrade ke member.')
      } else {
        setError('Gagal mengunduh file. Coba lagi.')
      }
      setStatus('error')
    }
  }

  const buttonContent = () => {
    switch (status) {
      case 'downloading':
        return (
          <>
            <Loader2 className="h-4 w-4 mr-2 animate-spin" />
            {progress}%
          </>
        )
      case 'success':
        return (
          <>
            <CheckCircle className="h-4 w-4 mr-2" />
            Selesai
          </>
        )
      case 'error':
        return (
          <>
            <AlertCircle className="h-4 w-4 mr-2" />
            Gagal
          </>
        )
      default:
        return (
          <>
            <Download className="h-4 w-4 mr-2" />
            Download
          </>
        )
    }
  }

  return (
    <div className="space-y-2">
      <Button
        onClick={handleDownload}
        disabled={disabled || status === 'downloading'}
        variant={status === 'error' ? 'destructive' : 'default'}
        size="sm"
        className="w-full"
      >
        {buttonContent()}
      </Button>
      {status === 'downloading' && (
        <Progress value={progress} className="h-1" />
      )}
      {error && (
        <p className="text-xs text-destructive">{error}</p>
      )}
    </div>
  )
}
```
  </action>
  <verify>
Run `npm ls axios` in frontend directory - should show axios installed.
Check `frontend/src/components/ui/progress.tsx` exists.
Check `frontend/src/components/member/DownloadButton.tsx` exists.

TypeScript should compile: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>axios installed, Progress component added, DownloadButton with progress tracking created.</done>
</task>

<task type="auto">
  <name>Task 2: Create downloads page</name>
  <files>
    frontend/src/app/(auth)/downloads/page.tsx
  </files>
  <action>
Create directory `frontend/src/app/(auth)/downloads/`.

Create `frontend/src/app/(auth)/downloads/page.tsx`:
```typescript
import { Metadata } from 'next'
import Link from 'next/link'
import { getUser } from '@/lib/auth/dal'
import { fetchAPI } from '@/lib/api-client'
import { redirect } from 'next/navigation'
import { EmptyState } from '@/components/member/EmptyState'
import { DownloadButton } from '@/components/member/DownloadButton'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { SITE_NAME } from '@/lib/constants'
import type { Template } from '@/types'
import { Download, Lock, FileSpreadsheet, FileText, ArrowRight, History } from 'lucide-react'
import { DownloadHistorySection } from './DownloadHistorySection'

export const metadata: Metadata = {
  title: `Download - ${SITE_NAME}`,
  description: 'Download template investasi dan tools analisis.',
}

function getFileIcon(filename: string) {
  const ext = filename.split('.').pop()?.toLowerCase()
  if (['xlsx', 'xls', 'csv'].includes(ext || '')) {
    return FileSpreadsheet
  }
  return FileText
}

function getFileExtension(url: string): string {
  try {
    const urlPath = new URL(url, 'http://localhost').pathname
    const filename = urlPath.split('/').pop() || ''
    const ext = filename.split('.').pop()
    return ext ? ext.toUpperCase() : 'FILE'
  } catch {
    const filename = url.split('/').pop() || ''
    const ext = filename.split('.').pop()
    return ext ? ext.toUpperCase() : 'FILE'
  }
}

export default async function DownloadsPage() {
  const user = await getUser()

  if (!user) {
    redirect('/login')
  }

  let templates: Template[] = []

  try {
    const data = await fetchAPI<{ templates: Template[] }>('/templates', {
      revalidate: 300,
    })
    templates = data.templates || []
  } catch {
    templates = []
  }

  // Filter templates based on user tier
  const accessibleTemplates = templates.filter(
    t => user.tier === 'member' || t.isFreePreview
  )
  const lockedTemplates = templates.filter(
    t => user.tier === 'free' && !t.isFreePreview
  )

  if (templates.length === 0) {
    return (
      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Download</h1>
          <p className="text-muted-foreground">Template dan tools investasi</p>
        </div>
        <EmptyState
          icon={<Download className="h-12 w-12 text-muted-foreground" />}
          title="Belum Ada Template"
          description="Template investasi akan segera tersedia. Pantau terus untuk update terbaru."
        />
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold tracking-tight">Download</h1>
        <p className="text-muted-foreground">
          {user.tier === 'member'
            ? 'Download semua template dan tools investasi'
            : 'Upgrade untuk akses ke semua template'}
        </p>
      </div>

      {/* Accessible Templates */}
      {accessibleTemplates.length > 0 && (
        <div className="space-y-4">
          <h2 className="text-lg font-semibold">
            {user.tier === 'member' ? 'Semua Template' : 'Template Gratis'}
          </h2>
          <div className="grid gap-4 md:grid-cols-2">
            {accessibleTemplates.map((template) => {
              const FileIcon = getFileIcon(template.fileUrl)
              const fileExt = getFileExtension(template.fileUrl)

              return (
                <Card key={template.id}>
                  <CardHeader className="flex flex-row items-start gap-4">
                    <div className="p-2 rounded-md bg-muted">
                      <FileIcon className="h-6 w-6 text-muted-foreground" />
                    </div>
                    <div className="flex-1 space-y-1">
                      <div className="flex items-start justify-between gap-2">
                        <CardTitle className="text-base">{template.title}</CardTitle>
                        <Badge variant="outline" className="text-xs">
                          {fileExt}
                        </Badge>
                      </div>
                      {template.description && (
                        <CardDescription className="text-sm">
                          {template.description}
                        </CardDescription>
                      )}
                    </div>
                  </CardHeader>
                  <CardContent>
                    <DownloadButton
                      templateId={template.id}
                      templateTitle={template.title}
                      fileUrl={template.fileUrl}
                    />
                  </CardContent>
                </Card>
              )
            })}
          </div>
        </div>
      )}

      {/* Locked Templates for Free Users */}
      {user.tier === 'free' && lockedTemplates.length > 0 && (
        <div className="space-y-4">
          <h2 className="text-lg font-semibold">Template Member</h2>
          <div className="grid gap-4 md:grid-cols-2">
            {lockedTemplates.map((template) => {
              const FileIcon = getFileIcon(template.fileUrl)
              const fileExt = getFileExtension(template.fileUrl)

              return (
                <Card key={template.id} className="opacity-75">
                  <CardHeader className="flex flex-row items-start gap-4">
                    <div className="p-2 rounded-md bg-muted">
                      <FileIcon className="h-6 w-6 text-muted-foreground" />
                    </div>
                    <div className="flex-1 space-y-1">
                      <div className="flex items-start justify-between gap-2">
                        <CardTitle className="text-base">{template.title}</CardTitle>
                        <Lock className="h-4 w-4 text-muted-foreground" />
                      </div>
                      {template.description && (
                        <CardDescription className="text-sm">
                          {template.description}
                        </CardDescription>
                      )}
                    </div>
                  </CardHeader>
                  <CardContent>
                    <Button variant="outline" size="sm" className="w-full" disabled>
                      <Lock className="h-4 w-4 mr-2" />
                      Member Only
                    </Button>
                  </CardContent>
                </Card>
              )
            })}
          </div>

          {/* Upgrade CTA */}
          <Card className="bg-primary/5 border-primary/20">
            <CardHeader>
              <CardTitle>Akses Semua Template</CardTitle>
              <CardDescription>
                Upgrade ke member untuk download {lockedTemplates.length} template premium.
              </CardDescription>
            </CardHeader>
            <CardContent>
              <Button asChild>
                <Link href="/pricing">
                  Lihat Harga
                  <ArrowRight className="ml-2 h-4 w-4" />
                </Link>
              </Button>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Download History Section */}
      <DownloadHistorySection />
    </div>
  )
}
```

Create `frontend/src/components/member/DownloadHistorySection.tsx` (client component for localStorage access):
```typescript
'use client'

import { useState, useEffect } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { getDownloadHistory, type DownloadRecord } from '@/lib/download-history'
import { History, FileText } from 'lucide-react'

export function DownloadHistorySection() {
  const [history, setHistory] = useState<DownloadRecord[]>([])
  const [mounted, setMounted] = useState(false)

  useEffect(() => {
    setMounted(true)
    setHistory(getDownloadHistory())
  }, [])

  // Don't render on server or if no history
  if (!mounted || history.length === 0) {
    return null
  }

  return (
    <div className="space-y-4">
      <h2 className="text-lg font-semibold flex items-center gap-2">
        <History className="h-5 w-5" />
        Riwayat Download
      </h2>
      <Card>
        <CardContent className="pt-6">
          <div className="space-y-3">
            {history.slice(0, 10).map((record, index) => (
              <div
                key={`${record.templateId}-${record.downloadedAt}-${index}`}
                className="flex items-center gap-3 text-sm"
              >
                <FileText className="h-4 w-4 text-muted-foreground" />
                <div className="flex-1 min-w-0">
                  <p className="font-medium truncate">{record.templateTitle}</p>
                  <p className="text-xs text-muted-foreground">{record.filename}</p>
                </div>
                <p className="text-xs text-muted-foreground whitespace-nowrap">
                  {new Date(record.downloadedAt).toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}
                </p>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
```
  </action>
  <verify>
Check files exist:
- `frontend/src/app/(auth)/downloads/page.tsx`
- `frontend/src/lib/download-history.ts`
- `frontend/src/components/member/DownloadHistorySection.tsx`

TypeScript should compile: `cd frontend && npx tsc --noEmit`
Build should succeed: `cd frontend && npm run build`
  </verify>
  <done>Downloads page created with tier-filtered templates, download buttons with progress, download history tracking via localStorage, and upgrade CTA for free users.</done>
</task>

</tasks>

<verification>
Run all verification commands:

```bash
cd frontend

# Check dependencies
npm ls axios

# Check TypeScript compiles
npx tsc --noEmit

# Check build succeeds
npm run build

# Verify file structure
ls -la src/app/\(auth\)/downloads/
ls -la src/components/member/
ls -la src/components/ui/progress.tsx
```

All should pass without errors.
</verification>

<success_criteria>
1. axios installed for download progress tracking
2. shadcn Progress component installed
3. DownloadButton shows progress, success, and error states
4. DownloadButton extracts filename safely from URL
5. Downloads page shows tier-filtered templates
6. Free users see locked templates with upgrade prompt
7. File icons based on extension (spreadsheet vs document)
8. Download history tracked in localStorage
9. Recent downloads displayed in history section
10. TypeScript compiles without errors
11. Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-frontend-member-area/07-07-SUMMARY.md`
</output>
